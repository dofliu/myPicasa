<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹•æ¼«é¢¨æ ¼ç…§ç‰‡è½‰æ›å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-hover': '#4F4ED1'
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .loading-dots::after {
            content: '';
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 min-h-screen transition-colors duration-300">
    <!-- Header -->
    <div class="gradient-bg text-white py-8">
        <div class="container mx-auto px-4 text-center">
            <h1 class="text-4xl font-bold mb-2">ğŸ¨ å‹•æ¼«é¢¨æ ¼è½‰æ›å™¨</h1>
            <p class="text-lg opacity-90">å°‡æ‚¨çš„ç…§ç‰‡è½‰æ›æˆå„ç¨®å‹•æ¼«é¢¨æ ¼çš„å¤§é ­è²¼</p>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- ä¸Šå‚³å€åŸŸ -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">ğŸ“¸ ä¸Šå‚³æ‚¨çš„ç…§ç‰‡</h2>
            <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 text-center">
                <input type="file" id="imageInput" accept="image/*" class="hidden">
                <div id="uploadArea" class="cursor-pointer" onclick="document.getElementById('imageInput').click()">
                    <div class="text-gray-400 mb-4">
                        <svg class="mx-auto h-12 w-12" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </div>
                    <p class="text-lg text-gray-600 dark:text-gray-400 mb-2">é»æ“Šä¸Šå‚³ç…§ç‰‡</p>
                    <p class="text-sm text-gray-500 dark:text-gray-500">æ”¯æ´ JPG, PNG, WebP æ ¼å¼</p>
                </div>
                <div id="imagePreview" class="mt-4 hidden">
                    <img id="previewImg" class="max-w-full max-h-64 mx-auto rounded-lg shadow-md">
                    <button onclick="clearImage()" class="mt-3 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                        æ¸…é™¤ç…§ç‰‡
                    </button>
                </div>
            </div>
        </div>

        <!-- API è¨­å®š -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">âš™ï¸ API è¨­å®š</h2>
            <div class="mb-4">
                <label for="geminiApiKeyInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">æ‚¨çš„ Gemini API Key (ç”¨æ–¼ç”Ÿæˆæè¿°):</label>
                <input type="password" id="geminiApiKeyInput" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white" placeholder="AIza...">
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">è«‹è¼¸å…¥æ‚¨çš„ Gemini API Keyã€‚æ­¤é‡‘é‘°åƒ…ç”¨æ–¼æ‚¨çš„ç€è¦½å™¨ï¼Œä¸æœƒå„²å­˜ã€‚</p>
            </div>
            <div class="mb-4">
                <label for="openaiApiKeyInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">æ‚¨çš„ OpenAI API Key (ç”¨æ–¼ç”Ÿæˆåœ–ç‰‡):</label>
                <input type="password" id="openaiApiKeyInput" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white" placeholder="sk-...">
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">è«‹è¼¸å…¥æ‚¨çš„ OpenAI API Keyã€‚æ­¤é‡‘é‘°åƒ…ç”¨æ–¼æ‚¨çš„ç€è¦½å™¨ï¼Œä¸æœƒå„²å­˜ã€‚</p>
            </div>
            <div class="mb-4">
                <label for="imageModelSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">é¸æ“‡åœ–ç‰‡ç”Ÿæˆæ¨¡å‹:</label>
                <select id="imageModelSelect" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white">
                    <option value="dall-e-3">DALL-E 3</option>
                    <option value="dall-e-2">DALL-E 2</option>
                </select>
            </div>
        </div>

        <!-- é¢¨æ ¼é¸æ“‡ -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">ğŸ­ é¸æ“‡å‹•æ¼«é¢¨æ ¼</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <div class="style-option border-2 border-gray-200 dark:border-gray-600 rounded-lg p-4 cursor-pointer hover:border-primary transition-colors" data-style="adventure">
                    <div class="text-center">
                        <div class="text-3xl mb-2">âš”ï¸</div>
                        <h3 class="font-semibold text-gray-800 dark:text-white">å†’éšªé¢¨</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">è‹±å‹‡å†’éšªè€…</p>
                    </div>
                </div>
                <div class="style-option border-2 border-gray-200 dark:border-gray-600 rounded-lg p-4 cursor-pointer hover:border-primary transition-colors" data-style="hero">
                    <div class="text-center">
                        <div class="text-3xl mb-2">ğŸ¦¸</div>
                        <h3 class="font-semibold text-gray-800 dark:text-white">è‹±é›„é¢¨æ ¼</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">è¶…ç´šè‹±é›„</p>
                    </div>
                </div>
                <div class="style-option border-2 border-gray-200 dark:border-gray-600 rounded-lg p-4 cursor-pointer hover:border-primary transition-colors" data-style="idol">
                    <div class="text-center">
                        <div class="text-3xl mb-2">âœ¨</div>
                        <h3 class="font-semibold text-gray-800 dark:text-white">å¶åƒé¢¨æ ¼</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">é–ƒè€€å¶åƒ</p>
                    </div>
                </div>
                <div class="style-option border-2 border-gray-200 dark:border-gray-600 rounded-lg p-4 cursor-pointer hover:border-primary transition-colors" data-style="ghibli">
                    <div class="text-center">
                        <div class="text-3xl mb-2">ğŸŒŸ</div>
                        <h3 class="font-semibold text-gray-800 dark:text-white">å‰åœåŠ›é¢¨æ ¼</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">å®®å´é§¿é¢¨</p>
                    </div>
                </div>
                <div class="style-option border-2 border-gray-200 dark:border-gray-600 rounded-lg p-4 cursor-pointer hover:border-primary transition-colors" data-style="naruto">
                    <div class="text-center">
                        <div class="text-3xl mb-2">ğŸƒ</div>
                        <h3 class="font-semibold text-gray-800 dark:text-white">ç«å½±å¿è€…</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">å¿è€…é¢¨æ ¼</p>
                    </div>
                </div>
                <div class="style-option border-2 border-gray-200 dark:border-gray-600 rounded-lg p-4 cursor-pointer hover:border-primary transition-colors" data-style="demonslayer">
                    <div class="text-center">
                        <div class="text-3xl mb-2">âš¡</div>
                        <h3 class="font-semibold text-gray-800 dark:text-white">é¬¼æ»…ä¹‹åˆƒ</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">é¬¼æ®ºéšŠé¢¨</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç”ŸæˆæŒ‰éˆ• -->
        <div class="text-center mb-8">
            <button id="generatePromptBtn" onclick="generatePrompt()" disabled class="px-8 py-4 bg-primary text-white rounded-lg font-semibold text-lg disabled:bg-gray-400 disabled:cursor-not-allowed hover:bg-primary-hover transition-colors">
                ğŸ“ ç”Ÿæˆåœ–ç‰‡æè¿°
            </button>
        </div>

        <!-- æç¤ºæè¿°å€åŸŸ -->
        <div id="promptDescriptionArea" class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-8 hidden">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">âœ¨ AI ç”Ÿæˆçš„åœ–ç‰‡æè¿°</h3>
            <div id="promptContent" class="text-gray-600 dark:text-gray-400 mb-4"></div>
            <div class="text-center">
                <button id="confirmGenerateBtn" onclick="confirmAndGenerateImage()" disabled class="px-8 py-4 bg-green-500 text-white rounded-lg font-semibold text-lg disabled:bg-gray-400 disabled:cursor-not-allowed hover:bg-green-600 transition-colors">
                    ğŸ¨ ç¢ºèªæè¿°ä¸¦ç”Ÿæˆåœ–ç‰‡
                </button>
            </div>
        </div>

        <!-- çµæœå€åŸŸ -->
        <div id="resultArea" class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 hidden">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">âœ¨ è½‰æ›çµæœ</h3>
            <div id="loadingState" class="text-center py-8">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-4"></div>
                <p class="text-gray-600 dark:text-gray-400 loading-dots">æ­£åœ¨ç”Ÿæˆæ‚¨çš„å‹•æ¼«é¢¨æ ¼ç…§ç‰‡</p>
            </div>
            <div id="resultContent" class="hidden">
                <div class="text-center">
                    <img id="resultImage" class="max-w-full max-h-96 mx-auto rounded-lg shadow-lg mb-4">
                    <div class="flex justify-center space-x-4">
                        <a id="downloadBtn" href="#" download="anime-style-avatar.png" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                            ğŸ’¾ ä¸‹è¼‰åœ–ç‰‡
                        </a>
                        <button onclick="resetApp()" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                            ğŸ”„ é‡æ–°é–‹å§‹
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ·±è‰²æ¨¡å¼æ”¯æ´
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        let selectedFile = null;
        let selectedStyle = null;
        let geminiApiKey = '';
        let openaiApiKey = '';
        let selectedImageModel = 'dall-e-3'; // Default image generation model
        let generatedPrompt = '';

        // é¢¨æ ¼å°æ‡‰çš„ä¸­æ–‡åç¨±
        const styleNames = {
            adventure: 'å†’éšªé¢¨',
            hero: 'è‹±é›„é¢¨æ ¼', 
            idol: 'å¶åƒé¢¨æ ¼',
            ghibli: 'å‰åœåŠ›é¢¨æ ¼',
            naruto: 'ç«å½±å¿è€…é¢¨æ ¼',
            demonslayer: 'é¬¼æ»…ä¹‹åˆƒé¢¨æ ¼'
        };

        // åœ–ç‰‡ä¸Šå‚³è™•ç†
        document.getElementById('imageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                selectedFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').classList.remove('hidden');
                    checkCanGenerate();
                };
                reader.readAsDataURL(file);
            }
        });

        // Gemini API Key è¼¸å…¥è™•ç†
        document.getElementById('geminiApiKeyInput').addEventListener('input', function(e) {
            geminiApiKey = e.target.value.trim();
            checkCanGenerate();
        });

        // OpenAI API Key è¼¸å…¥è™•ç†
        document.getElementById('openaiApiKeyInput').addEventListener('input', function(e) {
            openaiApiKey = e.target.value.trim();
            checkCanGenerate();
        });

        // åœ–ç‰‡æ¨¡å‹é¸æ“‡è™•ç†
        document.getElementById('imageModelSelect').addEventListener('change', function(e) {
            selectedImageModel = e.target.value;
            checkCanGenerate();
        });

        // é¢¨æ ¼é¸æ“‡è™•ç†
        document.querySelectorAll('.style-option').forEach(option => {
            option.addEventListener('click', function() {
                // ç§»é™¤ä¹‹å‰é¸ä¸­çš„æ¨£å¼
                document.querySelectorAll('.style-option').forEach(opt => {
                    opt.classList.remove('border-primary', 'bg-primary', 'bg-opacity-10');
                });
                
                // æ·»åŠ é¸ä¸­æ¨£å¼
                this.classList.add('border-primary', 'bg-primary', 'bg-opacity-10');
                selectedStyle = this.dataset.style;
                checkCanGenerate();
            });
        });

        function clearImage() {
            selectedFile = null;
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('imageInput').value = '';
            checkCanGenerate();
        }

        function checkCanGenerate() {
            const generatePromptBtn = document.getElementById('generatePromptBtn');
            const confirmGenerateBtn = document.getElementById('confirmGenerateBtn');

            // Enable generate prompt button if file, style, and Gemini API key are present
            if (selectedFile && selectedStyle && geminiApiKey) {
                generatePromptBtn.disabled = false;
            } else {
                generatePromptBtn.disabled = true;
            }

            // Enable confirm and generate image button if prompt is generated and OpenAI API key is present
            if (generatedPrompt && openaiApiKey) {
                confirmGenerateBtn.disabled = false;
            } else {
                confirmGenerateBtn.disabled = true;
            }
        }

        async function generatePrompt() {
            if (!selectedFile || !selectedStyle || !geminiApiKey) {
                showError("è«‹ç¢ºä¿å·²ä¸Šå‚³ç…§ç‰‡ã€é¸æ“‡é¢¨æ ¼ä¸¦è¼¸å…¥æ‚¨çš„ Gemini API Keyã€‚");
                return;
            }

            // é¡¯ç¤ºæç¤ºæè¿°å€åŸŸå’Œè¼‰å…¥ç‹€æ…‹
            document.getElementById('promptDescriptionArea').classList.remove('hidden');
            document.getElementById('promptContent').innerHTML = '<div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-primary mb-2"></div> æ­£åœ¨ç”Ÿæˆåœ–ç‰‡æè¿°...';
            document.getElementById('confirmGenerateBtn').disabled = true;
            document.getElementById('resultArea').classList.add('hidden'); // Hide result area if visible

            try {
                const promptForGemini = `è«‹ç‚ºä¸€å¼µä½¿ç”¨è€…ä¸Šå‚³çš„ç…§ç‰‡ï¼Œæ ¹æ“šã€Œ${styleNames[selectedStyle]}ã€çš„å‹•æ¼«é¢¨æ ¼ï¼Œç”Ÿæˆä¸€å€‹è©³ç´°çš„è‹±æ–‡åœ–ç‰‡ç”Ÿæˆæç¤ºï¼ˆpromptï¼‰ã€‚æç¤ºæ‡‰è©²åŒ…æ‹¬ï¼šè¦–è¦ºç‰¹å¾µã€è‰²å½©é¢¨æ ¼ã€ç·šæ¢ç‰¹é»ã€æ•´é«”æ°›åœï¼Œä»¥åŠå¦‚ä½•å°‡ç…§ç‰‡ä¸­çš„äººç‰©è½‰æ›ç‚ºå‹•æ¼«è§’è‰²ã€‚è«‹ç›´æ¥æä¾›è‹±æ–‡æç¤ºï¼Œä¸è¦åŒ…å«ä»»ä½•é¡å¤–èªªæ˜ã€‚`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiApiKey}`,
                {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: promptForGemini
                            }]
                        }]
                    })
                });

                const data = await response.json();

                if (response.ok && data.candidates && data.candidates.length > 0) {
                    generatedPrompt = data.candidates[0].content.parts[0].text.trim();
                    document.getElementById('promptContent').textContent = generatedPrompt;
                    checkCanGenerate();
                } else {
                    showError(`ç”Ÿæˆåœ–ç‰‡æè¿°å¤±æ•—: ${data.error ? data.error.message : 'æœªçŸ¥éŒ¯èª¤'}`);
                }
            } catch (err) {
                showError("ç”Ÿæˆåœ–ç‰‡æè¿°å¤±æ•—: " + err.message);
            }
        }

        async function confirmAndGenerateImage() {
            if (!generatedPrompt || !openaiApiKey) {
                showError("è«‹å…ˆç”Ÿæˆåœ–ç‰‡æè¿°ä¸¦è¼¸å…¥æ‚¨çš„ OpenAI API Keyã€‚");
                return;
            }

            // é¡¯ç¤ºçµæœå€åŸŸå’Œè¼‰å…¥ç‹€æ…‹
            document.getElementById('resultArea').classList.remove('hidden');
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('resultContent').classList.add('hidden');

            try {
                await generateImage(generatedPrompt);
            } catch (err) {
                showError("åœ–ç‰‡ç”Ÿæˆå¤±æ•—: " + err.message);
            }
        }

        async function generateImage(imagePrompt) {
            // OpenAI DALL-E API does not directly accept image attachments for image-to-image.
            // This example assumes text-to-image generation based on the prompt.
            // For image-to-image, a different API or approach would be needed.
            // The uploaded image is used to inform the Gemini prompt, but not directly sent to DALL-E.

            try {
                const response = await fetch('https://api.openai.com/v1/images/generations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${openaiApiKey}`
                    },
                    body: JSON.stringify({
                        model: selectedImageModel,
                        prompt: imagePrompt,
                        n: 1,
                        size: selectedImageModel === 'dall-e-3' ? '1024x1024' : '512x512', 
                        response_format: 'url'
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    if (data.data && data.data.length > 0) {
                        const imageUrl = data.data[0].url;
                        const resultImg = document.getElementById('resultImage');
                        resultImg.src = imageUrl;
                        
                        // è¨­ç½®ä¸‹è¼‰éˆæ¥
                        const downloadBtn = document.getElementById('downloadBtn');
                        downloadBtn.href = imageUrl;
                        
                        // é¡¯ç¤ºçµæœ
                        document.getElementById('loadingState').classList.add('hidden');
                        document.getElementById('resultContent').classList.remove('hidden');
                    } else {
                        showError("æœªèƒ½ç”Ÿæˆåœ–ç‰‡ï¼ŒAPI è¿”å›ç„¡æ•ˆæ•¸æ“šã€‚");
                    }
                } else {
                    showError(`åœ–ç‰‡ç”Ÿæˆå¤±æ•—: ${data.error ? data.error.message : 'æœªçŸ¥éŒ¯èª¤'}`);
                }
            } catch (err) {
                showError("åœ–ç‰‡ç”Ÿæˆå¤±æ•—: " + err.message);
            }
        }

        function showError(message) {
            const resultArea = document.getElementById('resultArea');
            resultArea.innerHTML = `
                <h3 class="text-xl font-bold text-red-600 mb-4">âŒ éŒ¯èª¤</h3>
                <p class="text-red-600 mb-4">${message}</p>
                <button onclick="resetApp()" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                    ğŸ”„ é‡æ–°é–‹å§‹
                </button>
            `;
            resultArea.classList.remove('hidden');
        }

        function resetApp() {
            // é‡ç½®æ‰€æœ‰ç‹€æ…‹
            selectedFile = null;
            selectedStyle = null;
            geminiApiKey = '';
            openaiApiKey = '';
            generatedPrompt = '';
            
            // æ¸…é™¤è¼¸å…¥æ¬„ä½
            document.getElementById('geminiApiKeyInput').value = '';
            document.getElementById('openaiApiKeyInput').value = '';

            // æ¸…é™¤åœ–ç‰‡é è¦½
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('imageInput').value = '';
            
            // æ¸…é™¤é¢¨æ ¼é¸æ“‡
            document.querySelectorAll('.style-option').forEach(opt => {
                opt.classList.remove('border-primary', 'bg-primary', 'bg-opacity-10');
            });
            
            // éš±è—çµæœå€åŸŸå’Œæç¤ºæè¿°å€åŸŸ
            document.getElementById('resultArea').classList.add('hidden');
            document.getElementById('promptDescriptionArea').classList.add('hidden');
            document.getElementById('promptContent').textContent = '';
            
            // é‡ç½®æŒ‰éˆ•
            checkCanGenerate();
            
            // æ»¾å‹•åˆ°é ‚éƒ¨
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html>