# 第二章：RAG 的演進之路（教學增強版）

在第一章中，我們將 RAG 比作一場「開卷考試」，它讓大型語言模型（LLM）從一個只能依賴記憶的「考生」，轉變為一個善於查閱資料的「高手」。然而，這場「開卷考試」的規則和技巧並非一成不變。從最初的簡單直接，到如今的精巧複雜，RAG 技術經歷了一條迷人的演進之路。本章將帶您穿越時空，追溯 RAG 從樸素（Naive）到高級（Advanced），再到模組化（Modular）和智能體化（Agentic）的發展歷程。

![圖 2-1：RAG 技術的演進之路](https://files.manuscdn.com/user_upload_by_module/session_file/310419663030348718/NILrxKWWTCAeYebt.png)

---

## 2.1 Naive RAG：最初的實現與樸素的智慧

時間回到 2020 年，當 Lewis 等人首次提出 RAG 的概念時，其形式非常純粹和直接，我們稱之為「Naive RAG」或樸素 RAG。它的核心思想就是將「檢索」和「生成」這兩個環節簡單地串聯起來，構成一個線性的工作流。

### 2.1.1 Naive RAG 的架構

Naive RAG 的架構可以用「索引-檢索-生成」三步曲來概括，這與我們在第一章介紹的基本流程完全一致。

![圖 2-2：Naive RAG 架構](https://files.manuscdn.com/user_upload_by_module/session_file/310419663030348718/HGYXTJHWuHmeKXpQ.png)

1.  **索引（Indexing）**：將文檔集合（知識庫）進行切塊，並通過嵌入模型轉換為向量，存入向量數據庫。
2.  **檢索（Retrieval）**：接收用戶查詢，將其嵌入為向量，然後在向量數據庫中進行相似度搜索，找出最相關的 Top-K 個文檔塊。
3.  **生成（Generation）**：將這 K 個文檔塊與原始查詢拼接成一個長長的提示（Prompt），然後餵給 LLM，由 LLM 生成最終答案。

> **簡單說明**：Naive RAG 就像一個剛學會開卷考試的學生。他知道在回答問題前要去翻書，但他翻書的技巧很簡單：根據問題中的關鍵詞，找到看起來最相關的幾頁，然後把這幾頁的內容一股腦地塞給大腦（LLM），讓大腦自己去理解和總結。

<br>

> **文句範例：Naive RAG 的運作**
>
> - **知識庫**：有一篇關於「巴黎聖母院」的介紹文章，其中一句是：「巴黎聖母院是一座位於法國巴黎市中心西堤島上的天主教教堂，大約建造於 1163 年到 1250 年間。」
> - **用戶查詢**：「巴黎聖母院是什麼時候建的？」
> - **Naive RAG 處理流程**：
>   1. **檢索**：系統在知識庫中找到了與查詢最相似的句子：「巴黎聖母院是一座位於法國巴黎市中心西堤島上的天主教教堂，大約建造於 1163 年到 1250 年間。」
>   2. **增強**：系統將查詢和檢索到的句子組合起來，形成一個新的提示（Prompt）。
>   3. **生成**：LLM 根據這個提示，生成答案：「巴黎聖母院大約建造於 1163 年到 1250 年間。」


### 2.1.2 Naive RAG 的局限性

儘管 Naive RAG 在很多場景下已經能顯著改善 LLM 的表現，但這種「樸素」的實現方式很快就暴露出了四大核心挑戰。

| 挑戰類別 | 具體問題 | 簡單比喻（開卷考試） |
| :--- | :--- | :--- |
| **低精度** | 檢索內容不相關 | 翻到的書頁雖然標題相關，但內容卻是另一回事。 |
| **低召回率** | 未能找到所有相關證據 | 考試重點分散在好幾章，但只翻了其中一章。 |
| **幻覺問題** | 生成與證據不符的答案 | 雖然找到了正確的公式，但在計算過程中自己編了一個步驟。 |
| **毒性問題** | 生成有害或偏見的內容 | 抄的參考資料本身就有錯誤或過時的觀點。 |

為了克服這些局限性，研究者們開始對這個簡單的流程進行「精裝修」，通過在檢索前後增加各種處理模組，RAG 技術由此邁入了「高級」階段。

> #### ✍️ **小節練習 2.1**
>
> 1.  **開放式問答**：請用您自己的話解釋，為什麼 Naive RAG 被稱為「樸素的」？它的「樸素」體現在哪個環節？
> 2.  **程式碼片段分析**：請分析 Naive RAG 的「索引-檢索-生成」流程中，哪一步是最大的性能瓶頸？並討論如何通過**批量處理（Batching）**來優化這個瓶頸。

---

## 2.2 Advanced RAG：精巧的優化與能力的飛躍

Advanced RAG 並不是一個全新的架構，而是在 Naive RAG 的基礎上，引入了一系列精巧的優化技術，旨在提升檢索的質量和生成的可靠性。這些技術主要圍繞著「檢索前（Pre-retrieval）」、「檢索中（Retrieval）」和「檢索後（Post-retrieval）」三個環節展開。

![圖 2-3：Advanced RAG 架構](https://files.manuscdn.com/user_upload_by_module/session_file/310419663030348718/pYHyuagkbWDnPnAQ.png)

### 2.2.1 檢索前優化：讓問題變得更「好」

檢索前優化的核心思想是：在進行搜索之前，先對原始的用戶查詢進行處理，使其更清晰、更具體，從而提高檢索的命中率。

1.  **查詢擴展 (Query Expansion)**：
    -   **原理**：當用戶的查詢過於簡短或模糊時，LLM 會根據原始查詢生成多個相關的、更詳細的查詢。例如，用戶查詢「RAG 的最新發展」，LLM 可能會擴展為「RAG-Fusion 的原理」、「Agentic RAG 的應用」等。
    -   **優勢**：通過多個查詢進行檢索，可以從多個角度捕捉用戶的真實意圖，顯著提高檢索的**召回率 (Recall)**。
2.  **查詢重寫 (Query Rewriting)**：
    -   **原理**：當用戶在多輪對話中提出查詢時，新的查詢往往依賴於歷史對話。LLM 會將當前查詢與歷史對話上下文結合，重寫成一個獨立、完整的查詢。
    -   **優勢**：解決了多輪對話中的**上下文丟失**問題，確保檢索結果的準確性。
3.  **進階技術：RAG-Fusion（查詢生成與融合）**
    -   **原理**：RAG-Fusion [5] 是一種極為有效的檢索前優化技術，旨在解決單一用戶查詢可能帶來的語義限制。它的核心思想是：
        1.  **假設性問題生成 (Hypothetical Document Embedding, HyDE)**：利用 LLM 根據用戶的原始查詢，**生成**多個可能的「假設性答案」或「相關問題」。
        2.  **多角度檢索**：將原始查詢和所有生成的假設性問題同時進行向量檢索，從而獲得多組檢索結果。
        3.  **結果融合 (Reciprocal Rank Fusion, RRF)**：使用 RRF 算法對所有檢索結果進行排序融合，將在多個檢索列表中排名靠前的文檔片段賦予更高的最終權重。
    -   **優勢**：通過從多個角度（原始意圖、假設性答案）進行檢索，極大地提高了檢索的**召回率**，尤其適用於用戶查詢較為模糊或簡短的場景。
4.  **知識庫優化 (Corpus Optimization)**：
    -   **原理**：在索引階段，對文檔進行預處理，例如：
        -   **摘要嵌入 (Summary Embedding)**：為每個文檔塊生成一個簡短摘要，並將摘要和原始文檔塊都進行嵌入。檢索時，先檢索摘要，再檢索文檔塊。
        -   **元數據過濾 (Metadata Filtering)**：為文檔塊附加結構化元數據（如日期、作者、主題），檢索時可以利用這些元數據進行精確過濾。
    -   **優勢**：提升檢索的**精準度 (Precision)**，特別是在處理大量結構化或半結構化數據時。

> **文句範例：查詢擴展 (Query Expansion)**
>
> - **原始查詢**：「RAG 的缺點」
> - **處理方式**：LLM 將這個簡單的查詢擴展成多個更具體的變體。
> - **擴展後的查詢**：
>   - 「檢索增強生成技術有哪些局限性？」
>   - 「如何解決 RAG 中的幻覺問題？」
>   - 「RAG 系統在檢索精度和召回率上面臨什麼挑戰？」
> - **效果**：通過同時搜索這幾個變體，系統更有可能找到全面覆蓋 RAG 各方面缺點的文檔。

### 2.2.2 檢索後優化：從「多」到「精」

檢索後優化的目標是，在將檢索到的文檔交給 LLM 之前，先對其進行篩選、排序和精煉，確保提供給 LLM 的是最高質量、最相關的「彈藥」。最核心的技術是 **重排序（Reranking）**。

> **文句範例：重排序 (Reranking)**
>
> - **用戶查詢**：「蘋果公司的最新財報表現如何？」
> - **初步檢索 (Top 3)**：
>   1. 一篇關於「蘋果種植技巧」的文章，因為包含了「蘋果」這個詞。（**低相關性**）
>   2. 蘋果公司官網的「關於我們」頁面。（**中等相關性**）
>   3. 一篇詳細分析蘋果公司最新季度財報的新聞稿。（**高相關性**）
> - **重排序處理**：一個更精準的重排序模型會依次分析這三個文檔與查詢的深層語義關係，最終將第 3 個文檔排在第一位。
> - **效果**：LLM 將只接收到最相關的新聞稿作為上下文，從而生成準確的答案，避免被「蘋果種植技巧」所干擾。

> #### ✍️ **小節練習 2.2**
>
> 1.  **開放式問答**：檢索器（Retriever）和重排序器（Reranker）的核心區別是什麼？為什麼在 Advanced RAG 中我們通常需要同時使用兩者，而不是只用一個更強大的模型？
> 2.  **程式碼片段分析**：請分析 RAG-Fusion 中使用的 **RRF (Reciprocal Rank Fusion)** 算法的優勢。為什麼 RRF 比簡單的排名相加更適合融合多個檢索結果？
>     - **第一輪**：「你好，我想了解一下 iPhone 15 Pro。"
>     - **第二輪**：「那它的攝像頭怎麼樣？」
>     如果直接將第二輪的「那它的攝像頭怎麼樣？」拿去檢索，可能會出現什麼問題？Advanced RAG 中的哪項技術專門用來解決這個問題？

---

#### 2.2.3 進階檢索策略：優化上下文的精準度

雖然重排序（Reranking）和查詢轉換（Query Transformation）能有效提升檢索結果的相關性，但它們並不能解決**檢索塊（Chunk）本身**的質量問題。傳統 RAG 往往面臨一個兩難困境：

*   **大塊（Large Chunk）**：包含豐富的上下文，但檢索時的語義匹配精準度低（因為向量平均了太多不相關的資訊）。
*   **小塊（Small Chunk）**：語義匹配精準度高，但檢索到的上下文不足，容易丟失關鍵資訊。

為了解決這個問題，業界發展出兩種主流的進階檢索策略，旨在實現**「用小塊檢索，用大塊生成」**的目標：

##### 1. 父子塊檢索 (Parent-Child Chunking)

*   **原理**：將文檔切割成兩種尺寸的塊：**小塊（Child Chunks）**用於向量檢索，**大塊（Parent Chunks）**用於作為 LLM 的最終上下文。
*   **流程**：
    1.  **索引階段**：將文檔切成大塊（例如 1024 字元），然後再將每個大塊切成多個小塊（例如 128 字元）。只將**小塊**嵌入並存入向量數據庫。
    2.  **檢索階段**：用戶查詢與向量數據庫中的**小塊**進行匹配。
    3.  **生成階段**：檢索到最相關的**小塊**後，系統會回溯到其對應的**大塊（Parent Chunk）**，並將這個包含完整上下文的大塊傳遞給 LLM 進行生成。
*   **優勢**：結合了小塊的高檢索精準度和大塊的豐富上下文，有效減少了上下文丟失和不相關資訊的干擾。

##### 2. 句子窗口檢索 (Sentence Window Retrieval)

*   **原理**：專注於句子級別的精準檢索，並在檢索到核心句子後，動態擴展上下文窗口。
*   **流程**：
    1.  **索引階段**：將文檔切分為單個句子。將每個**單獨的句子**嵌入並存入向量數據庫。
    2.  **檢索階段**：用戶查詢與向量數據庫中的**單個句子**進行匹配。
    3.  **生成階段**：檢索到最相關的句子後，系統會從原始文檔中提取該句子前後的 N 個句子（即**句子窗口**），將這個擴展後的上下文傳遞給 LLM 進行生成。
*   **優勢**：檢索精準度極高（因為是單句匹配），同時通過動態窗口確保了足夠的上下文，特別適用於需要精確定位事實的場景。

| 檢索策略 | 檢索對象 (Embedding) | 上下文對象 (LLM Input) | 核心優勢 | 適用場景 |
| :--- | :--- | :--- | :--- | :--- |
| **父子塊檢索** | 小塊 (e.g., 128字) | 大塊 (e.g., 1024字) | 兼顧檢索精準度與上下文完整性 | 複雜文檔、長篇報告、需要完整段落上下文的場景。 |
| **句子窗口檢索** | 單個句子 | 句子 ± N 句 (動態窗口) | 檢索精準度極高，上下文動態調整 | 問答系統、事實定位、需要精確引用原文的場景。 |

---

## 2.3 Modular RAG：靈活的積木式架構

如果說 Naive RAG 是一條固定的流水線，Advanced RAG 是在流水線上增加了幾個處理工位，那麼 Modular RAG 則是將整個生產線拆解成一個個獨立的、可互換的模組，並引入一個「總調度員」來根據任務需求動態地組裝這些模組。

![圖 2-4：Modular RAG 架構](https://files.manuscdn.com/user_upload_by_module/session_file/310419663030348718/xJuNirXbDoTrVcGo.png)

> **文句範例：Modular RAG 的靈活調度**
>
> - **用戶查詢**：「請幫我總結一下《沙丘》小說和 2021 年電影版的情節差異。」
> - **Modular RAG 處理流程**：
>   1. **查詢分析模組**：識別出這是一個「對比總結」類型的複雜查詢，需要從兩個不同的知識來源獲取資訊。
>   2. **編排器**：決定並行啟用兩個檢索流程。
>   3. **檢索模組**：
>      - **流程 A**：從「小說知識庫」中檢索《沙丘》的情節。
>      - **流程 B**：從「電影知識庫」中檢索 2021 年版《沙丘》的情節。
>   4. **融合模組**：將兩個流程檢索到的內容進行整合。
>   5. **生成模組**：LLM 根據整合後的上下文，生成一份關於小說和電影情節差異的詳細對比報告。
>
> **文句範例：Modular RAG 的多源異構檢索**
>
> - **用戶查詢**：「工廠自動化設備發生 F-503 警報，請提供診斷步驟和維修建議。」
> - **Modular RAG 處理流程**：
>   1. **查詢分析模組**：識別出這是一個「故障診斷」類型的複雜查詢，需要從多個異構知識來源獲取資訊。
>   2. **編排器**：決定並行啟用五個檢索流程。
>   3. **檢索模組**：
>      - **流程 A**：從「規格文件數據庫」中檢索 F-503 警報的定義。
>      - **流程 B**：從「使用手冊數據庫」中檢索 F-503 警報的標準處理流程。
>      - **流程 C**：從「維修紀錄數據庫」中檢索歷史上 F-503 警報的解決方案。
>      - **流程 D**：從「警報清單數據庫」中檢索 F-503 警報的優先級和影響範圍。
>      - **流程 E**：從「監控資料數據庫」中檢索發生警報時的實時數據（例如：溫度、電壓）。
>   4. **融合模組**：將五個流程檢索到的內容進行整合。
>   5. **生成模組**：LLM 根據整合後的上下文，生成一份包含診斷、步驟和歷史經驗的詳細維修報告。
>      - **流程 A**：從「小說知識庫」中檢索《沙丘》的情節。
>      - **流程 B**：從「電影知識庫」中檢索 2021 年版《沙丘》的情節。
>   4. **融合模組**：將兩個流程檢索到的內容進行整合。
>   5. **生成模組**：LLM 根據整合後的上下文，生成一份關於小說和電影情節差異的詳細對比報告。

> #### ✍️ **小節練習 2.3**
>
> 1.  **開放式問答**：相比於 Advanced RAG，Modular RAG 最大的架構優勢是什麼？請用「解耦」和「編排」這兩個詞來解釋。
> 2.  **程式碼片段分析**：請討論在 Modular RAG 中，**編排器（Orchestrator）**的設計難點。如果編排器本身是一個 LLM，它在決定流程時可能面臨哪些**決策延遲**和**成本**問題？

---

## 2.4 Agentic RAG：從工具到智慧體

Agentic RAG 代表了 RAG 系統的最高級形式，它將大型語言模型（LLM）從一個單純的問答機器，轉變為一個具備**規劃、反思和工具使用能力**的自主智慧體（Agent）。

#### 2.4.1 核心機制：規劃、反思與工具使用

Agentic RAG 的核心在於賦予 LLM 執行複雜任務的能力，其流程不再是單純的「檢索-生成」，而是：

1.  **規劃（Planning）**：LLM 將複雜的用戶查詢分解為一系列可執行的子任務。
2.  **工具使用（Tool Use）**：LLM 根據子任務選擇合適的工具，例如：
    *   **檢索工具**：用於從向量數據庫中獲取知識。
    *   **代碼執行工具**：用於計算或數據處理。
    *   **外部 API 工具**：用於獲取即時資訊（如天氣、股價）。
3.  **反思（Reflection）**：LLM 評估每一步的執行結果，判斷是否需要修正或重新規劃。

#### 2.4.2 實戰案例：跨系統自動化報告生成

Agentic RAG 在企業自動化中展現出巨大潛力。以「**自動生成季度營運報告**」為例：

| 步驟 | Agent 行為 | RAG 應用 |
| :--- | :--- | :--- |
| **1. 規劃** | Agent 將任務分解為：獲取銷售數據、獲取市場分析報告、整合數據、撰寫報告。 | N/A |
| **2. 數據獲取** | Agent 呼叫 **SQL 工具** 查詢數據庫獲取銷售數據。 | N/A |
| **3. 知識檢索** | Agent 呼叫 **RAG 檢索工具**，查詢「上季度市場分析報告」和「公司報告撰寫規範」。 | RAG 確保 Agent 獲取到**最新、最準確**的市場分析和格式要求。 |
| **4. 整合與分析** | Agent 呼叫 **代碼執行工具**（如 Python）對銷售數據和市場報告進行交叉分析。 | N/A |
| **5. 報告撰寫** | Agent 根據所有獲取的數據和知識，撰寫報告草稿。 | RAG 確保報告內容**忠誠於**檢索到的事實和數據。 |
| **6. 反思與修正** | Agent 評估報告草稿是否符合「撰寫規範」，若不符，則返回步驟 5 修正。#### 2.4.3 貼近生活的應用場景

Agentic RAG 的核心價值在於**決策輔助**和**複雜流程處理**，這使其在非工程領域同樣具有顛覆性：

| 領域 | 應用場景 | RAG 核心價值 |
| :--- | :--- | :--- |
| **法律** | **合同條款審核與風險評估** | Agent 檢索**數百萬份判例**和**法規條文**，並根據合同內容進行交叉比對，標記潛在的法律風險和不一致條款。 |
| **醫療** | **個性化診斷與治療方案推薦** | Agent 檢索**最新醫學論文**、**患者病歷**和**藥物數據庫**，為醫生提供基於證據的個性化治療建議。 |
| **金融** | **即時市場監控與交易決策** | Agent 實時監控**新聞、社交媒體**和**財報數據**，結合 RAG 檢索歷史市場事件，為交易員提供快速、多維度的決策支持。 |

---

#### 2.4.4 實戰範例導讀：Agentic RAG 視覺化案例分析

為了讓讀者更直觀地理解 Agentic RAG 的運作機制，我們將三個實戰範例的核心流程和最終成果以視覺化方式呈現。這些範例的**完整程式碼與詳細步驟**已收錄於**本書後續的「專案實戰」章節**（或**附錄**），建議讀者在完成基礎理論學習後，再進行實作。

---

##### 案例一：季度報告自動生成 (CrewAI)

**核心機制**：多 Agent 協作，將複雜任務分解給專業 Agent（數據分析師、市場研究員、報告撰寫、審核），體現了 Agentic RAG 在**流程編排**上的優勢。

![圖 2-6：CrewAI 季度報告生成系統 Agentic RAG 流程](https://files.manuscdn.com/user_upload_by_module/session_file/310419663030348718/YmACrrkvilgjgKfV.png)

**成果展示**：Agent 協作生成的結構化報告，確保了數據的準確性和分析的深度。

![圖 2-7：CrewAI 季度報告生成結果模擬](https://files.manuscdn.com/user_upload_by_module/session_file/310419663030348718/nsAmNHAbiNZZrFyg.png)

---

##### 案例二：季度報告自動生成 (LangChain)

**核心機制**：單一 Agent 決策循環，通過 **Thought-Action-Observation** 循環動態選擇 RAG 檢索工具或 SQL 查詢工具，體現了 Agentic RAG 在**工具調用**上的靈活性。

![圖 2-8：LangChain 智能體 RAG 季度報告生成流程圖](https://files.manuscdn.com/user_upload_by_module/session_file/310419663030348718/KZTqkSlRfZYjGtgG.png)

**成果展示**：Agent 獨立生成報告，並能明確指出其數據來源和分析依據。

![圖 2-9：LangChain 季度報告生成結果模擬](https://files.manuscdn.com/user_upload_by_module/session_file/310419663030348718/ghbXxwkDOnKprjIZ.png)

---

##### 案例三：風力發電場故障診斷與維修準備 (CrewAI)

**核心機制**：基於 CrewAI 的**多跳（Multi-hop）RAG** 流程，將「警報解碼」和「工具規劃」兩個獨立的 RAG 檢索任務串聯起來，實現複雜的工業推理。

![圖 2-10：基於 CrewAI 的多跳代理 RAG 風場故障診斷流程](https://files.manuscdn.com/user_upload_by_module/session_file/310419663030348718/iTPRNVqPzROKDtzB.png)

**成果展示**：Agent 最終生成一份結構清晰、專業的維修工單，包含故障詳情、排除步驟和所需工具清單。

![圖 2-11：風力發電機維修工單生成結果模擬](https://files.manuscdn.com/user_upload_by_module/session_file/310419663030348718/vkrVODjBoneiWFux.png)

---

我們強烈建議讀者在閱讀完本書所有理論章節後，親手運行這些範例，並嘗試修改其中的 Agent 角色、任務和知識庫，以加深對 Agentic RAG 的理解。

---

## 2.5 前沿方法巡禮：自我優化與糾錯機制在於**決策輔助**和**複雜流程處理**，這使其在非工程領域同樣具有顛覆性：

| 領域 | 應用場景 | RAG 核心價值 |
| :--- | :--- | :--- |
| **法律** | **合同條款審核與風險評估** | Agent 檢索**數百萬份判例**和**法規條文**，並根據合同內容進行交叉比對，標記潛在的法律風險和不一致條款。 |
| **醫療** | **個性化診斷與治療方案推薦** | Agent 檢索**最新醫學論文**、**患者病歷**和**藥物數據庫**，為醫生提供基於證據的個性化治療建議。 |
| **金融** | **即時市場監控與交易決策** | Agent 實時監控**新聞、社交媒體**和**財報數據**，結合 RAG 檢索歷史市場事件，為交易員提供快速、多維度的決策支持。 |

---

## 2.5 前沿方法巡禮：自我優化與糾錯機制

Agentic RAG 代表了 RAG 技術的最新前沿。它不再是一個被動執行預定流程的系統，而是一個具有「主動性」和「自主決策能力」的智能體（Agent）。

> **文句範例：Agentic RAG 的自主推理**
>
> - **用戶查詢**：「目前特斯拉的股價是多少？根據最近的財報，分析一下現在是否是買入的好時機。」

> **文句範例：Agentic RAG 的故障診斷**
>
> - **用戶查詢**：「工廠自動化設備發生 F-503 警報，請提供診斷步驟和維修建議。」
> - **Agentic RAG 處理流程**：
>   1. **自主規劃**：智能體將任務分解為：(1) 獲取實時數據；(2) 檢索警報定義與處理手冊；(3) 檢索歷史維修紀錄；(4) 綜合分析並生成維修報告。
>   2. **工具使用 (步驟 1)**：智能體決定調用「監控系統 API」這個外部工具，獲取 F-503 發生時的溫度、電壓等實時數據。
>   3. **迭代檢索 (步驟 2 & 3)**：智能體在內部知識庫中依序檢索「警報清單」、「規格文件」和「維修紀錄」，並根據實時數據和警報定義，**動態調整**檢索關鍵詞（例如：從「F-503」調整為「F-503 + 高溫」）。
>   4. **自我評估與生成 (步驟 4)**：智能體結合所有數據和文檔，生成一份包含「診斷結論」、「維修步驟」和「預防建議」的報告。
> - **Agentic RAG 處理流程**：
>   1. **自主規劃**：智能體將任務分解為三個步驟：(1) 獲取實時股價；(2) 查找並閱讀最新財報；(3) 結合前兩者進行分析並給出建議。
>   2. **工具使用 (步驟 1)**：智能體決定調用「雅虎財經 API」這個外部工具，獲取到特斯拉的實時股價為 180 美元。
>   3. **迭代檢索 (步驟 2)**：智能體先在內部知識庫中檢索財報，發現只有上一季度的。它判斷資訊過時，於是**主動調整策略**，使用「網路搜尋」工具找到了最新的財報摘要。
>   4. **自我評估與生成 (步驟 3)**：智能體結合股價和最新財報，生成分析報告，並在報告中明確指出其分析是基於哪些資訊來源，增加了答案的透明度和可信度。

> #### ✍️ **小節練習 2.4**
>
> 1.  **開放式問答**：Agentic RAG 與前面三種 RAG（Naive, Advanced, Modular）最根本的區別是什麼？請用「被動執行」與「主動決策」來闡述。
> 2.  **程式碼片段分析**：請分析 Agentic RAG 中的「反思（Reflection）」機制。如果 Agent 決定對其檢索結果進行反思，它需要哪些**評估指標**來判斷檢索結果是否合格？

---

## 2.5 前沿方法巡禮：自我優化與糾錯機制

在本節中，我們將深入探討三個最具代表性的前沿方法，它們可以被看作是實現 Agentic RAG 或優化 Modular RAG 的具體技術路徑。

#### 2.5.1 自我檢索增強生成 (Self-RAG)

Self-RAG [1] 的核心思想是讓大型語言模型 (LLM) 在生成答案的過程中，**自主決定**是否需要檢索、何時檢索，以及如何評估檢索結果。它將 RAG 從一個被動的流程轉變為一個主動的、具備「自我反思 (Self-Reflection)」能力的智能體。

> **文句範例：Self-RAG 的自主決策**
>
> **用戶查詢**：「RAG 的核心優勢是什麼？」
>
> **LLM 內部思考**：
> 1. **判斷**：這個問題是通用知識，不需要檢索。**（生成 Reflection Token: [No Retrieval]）**
> 2. **生成答案**：RAG 的核心優勢在於解決 LLM 的知識時效性問題和幻覺問題。
>
> **用戶查詢**：「請比較 2023 年和 2024 年 RAG 論文的數量。」
>
> **LLM 內部思考**：
> 1. **判斷**：這個問題需要外部數據支持。**（生成 Reflection Token: [Needs Retrieval]）**
> 2. **檢索**：發出檢索請求，獲得兩篇論文摘要。
> 3. **評估**：檢索結果包含具體數字，是可靠的。**（生成 Reflection Token: [High Quality]）**
> 4. **生成答案**：根據檢索結果，2024 年 RAG 論文數量比 2023 年增長了 50%。

#### 2.5.2 糾錯式檢索增強生成 (Corrective RAG, CRAG)

CRAG [2] 專注於解決檢索結果不可靠的問題。它在檢索階段之後增加了一個「知識評估」模組，用於判斷檢索到的文檔是否足夠支持回答。

> **文句範例：CRAG 的糾錯機制**
>
> **用戶查詢**：「Manus AI 是哪一年成立的？」
>
> **檢索結果**：
> - 文檔 A：Manus AI 於 2025 年發布了其第一個產品。
> - 文檔 B：Manus 團隊在 2024 年開始組建。
>
> **CRAG 知識評估**：
> 1. **判斷**：檢索結果不足以直接回答「成立年份」，存在歧義。**（生成 Feedback: [Ambiguous]）**
> 2. **糾錯**：觸發「知識擴展」機制，將查詢擴展為「Manus AI 團隊組建年份」和「Manus AI 產品發布年份」，並進行二次檢索。
> 3. **生成答案**：根據二次檢索結果，Manus AI 團隊於 2024 年開始組建，並於 2025 年發布了第一個產品。

#### 2.5.3 自適應檢索增強生成 (Adaptive RAG)

Adaptive RAG [3] 的核心思想是根據查詢的**複雜度**和**領域**，動態調整 RAG 流程中的各個模組。它不再使用單一固定的 RAG 流程，而是為每個查詢量身定做。

> **文句範例：Adaptive RAG 的動態策略**
>
> **查詢類型 1：簡單事實查詢**（例如：「RAG 的全稱是什麼？」）
> - **策略**：跳過複雜的查詢重寫和重排序，直接進行單次檢索和生成。
>
> **查詢類型 2：複雜推理查詢**（例如：「請分析 RAG 在金融領域的潛在風險。」）
> - **策略**：啟用查詢重寫、多跳檢索（Multi-hop Retrieval）、以及多個重排序器（Re-ranker）進行精確篩選，然後再進行生成。

> #### ✍️ **小節練習 2.5**
>
> 1. **開放式問答**：請解釋 Self-RAG 中的「自我反思 (Self-Reflection)」機制與傳統 RAG 的主要區別。
> 2. **程式碼片段分析**：請討論 CRAG (Corrective RAG) 的「知識評估」模組在實作時，如何判斷檢索結果是「足夠支持 (Sufficient)」還是「需要擴展 (Need Expansion)」？這一步驟通常使用哪種模型來實現？
> 3. **思考題**：Adaptive RAG 如何通過「複雜度感知」來優化資源消耗？

---

## 2.7 GraphRAG 與 Agentic RAG 的未來展望

### 2.7.1 GraphRAG：從向量到關係

傳統的 RAG 依賴於向量相似度，擅長處理語義相似的內容，但在處理**實體間的複雜關係**和**多跳推理 (Multi-hop Reasoning)**時表現較弱。GraphRAG 則通過以下三個步驟解決了這個問題：

1.  **知識圖譜構建 (Knowledge Graph Construction)**：利用 LLM 或專門的抽取工具，從非結構化文本中識別出**實體 (Entities)**、**關係 (Relationships)**和**屬性 (Attributes)**，並將其構建成圖譜。
2.  **基於圖的檢索 (Graph-based Retrieval)**：當用戶提出查詢時，系統不再是檢索相似的文本塊，而是檢索圖譜中相關的**節點 (Nodes)**和**邊 (Edges)**，特別是通過**多跳推理**來找到間接的、隱藏的關係路徑。
3.  **生成 (Generation)**：將檢索到的相關子圖或路徑，連同原始查詢一起輸入給 LLM，生成最終答案。

GraphRAG 的核心優勢在於它能夠回答「為什麼」和「如何」這類需要**邏輯鏈條**的問題，例如：「A 公司的產品 B 是由哪家供應商提供的？該供應商是否也為 C 公司提供服務？」

![圖 2-5：GraphRAG 流程概念圖](/home/ubuntu/rag_chapter2_fig5_graphrag_concept.png)

### 2.7.2 Agentic RAG：RAG 的終極形態

Agentic RAG 代表了 RAG 技術的終極目標，它將 RAG 系統從一個被動的執行者轉變為一個具有自主決策能力的智能體（Agent）。它不僅能檢索，還能**規劃、反思、使用工具**，是 Modular RAG 和 Self-RAG 的集大成者。

> #### ✍️ **小節練習 2.7**
>
> 1.  **概念題**：GraphRAG 相較於傳統的向量檢索，在處理知識時最大的優勢是什麼？請用「多跳推理」來闡述。
> 2.  **應用思考題**：請舉例說明 Agentic RAG 在一個複雜的金融分析任務中，如何體現其「自主規劃」和「工具使用」的能力。

### **2#### 2.7.1 圖檢索增強生成 (GraphRAG)

GraphRAG [4] 是一種將知識庫轉化為**知識圖譜 (Knowledge Graph, KG)** 的 RAG 範式。它將文檔中的實體（Entities）和它們之間的關係（Relationships）明確地表示出來，從而實現更精確、更具推理能力的檢索。

> **連貫性說明**：GraphRAG 是處理第四章中**工程圖、複雜合同、法規文件**等具有強烈結構和關係依賴數據的理想方案。它解決了傳統向量檢索無法進行「多跳推理」（Multi-hop Reasoning）的問題。例如，查詢「與 R1 電阻相連的電容型號」需要兩次跳轉（R1 -> 連接線 -> 電容型號），這是向量檢索難以做到的。

#### 2.7.2 智能體檢索增強生成 (Agentic RAG)

Agentic RAG 是 RAG 演進的終極形態，它將 RAG 系統視為一個具備自主規劃、工具使用和自我評估能力的智能體（Agent）。它不僅能檢索，還能像人類一樣**規劃**檢索步驟、**使用**多個工具（例如：向量數據庫、SQL 數據庫、API）並**評估**結果。

---
## 2.8 本章小結
在本章，我們追溯了 RAG 技術從 2020 年至今的演進之路。這場演進不僅是技術的疊代，更是對 RAG 系統**可靠性、準確性和推理能力**的持續追求。我們從最初的 Naive RAG（樸素 RAG）開始，它雖然簡單，但為 RAG 奠定了基礎。隨後，Advanced RAG（進階 RAG）通過引入檢索前和檢索後的優化技術，顯著提升了檢索的精度和召回率。Modular RAG（模組化 RAG）則將 RAG 系統的設計提升到了一個新的高度，通過靈活的模組組合和編排器，使其能夠應對多源異構和複雜的業務邏輯。

最後，我們探討了 RAG 的前沿與未來：Self-RAG、CRAG 和 Adaptive-RAG 等自我優化和糾錯機制，以及 Agentic RAG（智能體 RAG）和 GraphRAG（圖 RAG）。Agentic RAG 代表了 RAG 的終極形態，它賦予了系統自主決策和工具使用的能力；而 GraphRAG 則為 RAG 提供了處理複雜關係和多跳推理的強大武器。

下表總結了 RAG 演進的四個階段及其核心特徵：

| 階段 | 時間範圍 | 核心特徵 | 代表方法 | 適用場景 |
| :--- | :--- | :--- | :--- | :--- |
| Naive RAG | 2020-2022 | 簡單的線性流程 | 基本的檢索、生成 | 簡單問答、概念驗證 |
| Advanced RAG | 2022-2024 | 檢索前後優化 | 查詢擴展、重排序 | 企業知識庫、客服系統 |
| Modular RAG | 2024+ | 模組化、可擴展 | 靈活的模組組合 | 複雜場景、多源異構 |
| Agentic RAG | 2024+ | 自主決策、迭代推理 | Self-RAG、Adaptive-RAG | 研究助手、複雜任務 |

從下一章開始，我們將深入 RAG 的核心構建模塊，從**文本切片的藝術**講起，逐步揭示 RAG 系統的每一個技術細節。我們將在第三章探討純文本的切片方法，並在第四章深入探討多模態數據的處理策略。節。

---

## 參考文獻

## 參考文獻

[1] Asai, A., Wu, Z., Wang, Y., Sil, A., & Hajishirzi, H. (2023). Self-RAG: Learning to Retrieve, Generate, and Critique through Self-Reflection. *arXiv preprint arXiv:2310.11511*.
[2] Shi, W., et al. (2024). Corrective Retrieval Augmented Generation. *arXiv preprint arXiv:2401.15884*.
[3] Jeong, S., Baek, J., Cho, S., Hwang, S. J., & Park, J. C. (2024). Learning to Adapt Retrieval-Augmented Large Language Models through Question Complexity. *NAACL 2024*.
[4] GraphRAG: Unlocking LLM Capabilities on Knowledge Graphs. *Preprint 2024*.
[5] Gao, Y., Xiong, Y., Gao, X., Jia, K., Pan, J., Bi, Y., ... & Wang, H. (2023). Retrieval-Augmented Generation for Large Language Models: A Survey. *arXiv preprint arXiv:2312.10997*.


---

## 🧠 第二章：章末綜合練習

恭喜您完成了第二章的學習！現在，讓我們通過一系列的綜合練習，來鞏固和拓展您對 RAG 演進之路的理解。

### 第一部分：概念回顧

**一、選擇題**

1.  下列哪一項**不屬於** Naive RAG 面臨的主要挑戰？
    A. 幻覺問題 (Hallucination)
    B. 檢索內容的低精度 (Low Precision)
    C. 處理多語言查詢 (Multilingual Queries)
    D. 知識來源的毒性與偏見 (Toxicity & Bias)

2.  在 Advanced RAG 中，「重排序 (Reranking)」這一技術主要發生在哪個階段？
    A. 檢索前 (Pre-retrieval)
    B. 檢索中 (In-retrieval)
    C. 檢索後 (Post-retrieval)
    D. 生成中 (In-generation)

3.  Modular RAG 架構的核心優勢在於其靈活性和可擴展性，這主要得益於哪兩個設計原則？
    A. 耦合與繼承 (Coupling & Inheritance)
    B. 解耦與編排 (Decoupling & Orchestration)
    C. 封裝與多態 (Encapsulation & Polymorphism)
    D. 抽象與聚合 (Abstraction & Aggregation)

4.  哪種前沿 RAG 方法的核心思想是「根據問題的複雜度，動態選擇不同的處理策略」？
    A. Self-RAG
    B. Corrective RAG (CRAG)
    C. Agentic RAG
    D. Adaptive-RAG

**二、填空題**

1.  在多輪對話場景中，為了理解像「它」這樣的代詞，Advanced RAG 通常會使用 ___________ 技術來重寫查詢。
2.  Agentic RAG 的核心特徵是其「主動性」和「自主決策能力」，它能夠進行自主規劃、自我評估、迭代檢索和 ___________。
3.  Self-RAG 通過在生成過程中引入特殊的 ___________，來實現對檢索和生成行為的自我反思與控制。

### 第二部分：應用設計

**三、簡答與設計題**

1.  **場景描述**：您正在為一家新聞媒體公司設計一個「歷史新聞查詢」RAG 系統。該系統的知識庫包含了過去 50 年的所有新聞稿件。用戶可能會提出非常模糊的查詢，例如「1990 年代美國經濟發生了什麼大事？」

    **問題**：
    a. 僅使用 Naive RAG 處理此類模糊查詢，可能會遇到什麼困難？
    b. 請設計一個基於 Advanced RAG 的優化方案來應對這個挑戰。您的方案應至少包含一項「檢索前」優化技術和一項「檢索後」優化技術。

2.  **場景描述**：您需要為一個電商平台開發一個智能導購機器人。這個機器人需要能夠回答用戶關於產品的各種問題，同時還能查詢庫存、比較不同產品的價格、甚至幫助用戶下單。

    **問題**：
    a. 為什麼說 Agentic RAG 是實現這個智能導購機器人的理想架構？
    b. 請列出這個 Agentic RAG 系統可能需要的三種外部工具（Tool），並簡要說明它們各自的用途。

### 第三部分：案例分析

**四、案例分析題**

**背景一：IT 幫助台 RAG 系統**

**專題挑戰題：Agentic RAG 實戰**

為了讓讀者將本章所學的 Agentic RAG 知識應用於實踐，我們設計了以下專題挑戰題。請參考**本書後續「專案實戰」章節**（或**配套程式碼庫**）中提供的三個實戰範例，並嘗試完成以下挑戰：

1.  **進階報告生成挑戰**：在「季度報告自動生成 (CrewAI)」範例的基礎上，加入一個新的 Agent 角色：「數據驗證師」，該 Agent 必須在報告生成前，使用一個外部工具（例如：一個模擬的數據庫查詢工具）來驗證報告中引用的所有數字是否準確。
2.  **多跳推理挑戰**：在「風力發電場故障診斷與維修準備 (CrewAI)」範例的基礎上，增加一個新的知識庫：「供應商聯繫資訊」。要求 Agent 在生成維修工單時，如果發現需要更換的零件（例如：角度校準儀 AC-300），必須自動檢索並加入該零件的**供應商名稱**和**聯繫電話**。
3.  **框架對比挑戰**：嘗試將「風力發電場故障診斷與維修準備」的邏輯，從 CrewAI 框架遷移到 LangChain 框架，並比較兩種框架在實現多跳 RAG 流程時的優劣。

**背景二：工廠自動化故障診斷系統**

一家大型企業的內部 IT 幫助台每天都會收到大量來自員工的求助郵件，內容從「如何重置密碼」到「我的電腦無法連接到特定伺服器，錯誤代碼 503」等，難度不一。為了提升效率，公司決定引入一個 RAG 系統來自動回答這些問題。



**背景二：工廠自動化故障診斷系統**

一家大型製造工廠的自動化設備經常會發出故障警報。當一個警報事件（例如：F-503 警報）發生後，維修人員需要迅速查閱以下五種異構數據源來進行診斷：
1. **規格文件**：設備的設計參數和技術標準。
2. **使用手冊**：標準的故障排除步驟。
3. **維修紀錄**：歷史上類似故障的解決方案。
4. **警報清單**：F-503 警報的官方定義和影響範圍。
5. **監控資料**：警報發生時的實時數據（例如：溫度、電壓）。

**問題**：

4.  **Modular RAG 設計**：請設計一個基於 Modular RAG 的故障診斷系統。您的設計應明確說明如何利用「編排器 (Orchestrator)」來協調這五種異構數據源的檢索，並說明這種架構相對於 Naive RAG 的優勢。

5.  **Agentic RAG 升級**：如果將該系統升級為 Agentic RAG，請描述智能體如何利用「工具使用 (Tool Use)」的能力來處理 **監控資料**（實時數據），並說明 Agentic RAG 在這個場景下比 Modular RAG 多了哪些「主動性」？

6.  **GraphRAG 應用**：在處理**規格文件**和**維修紀錄**時，您認為 GraphRAG 可以發揮什麼作用？請舉例說明 GraphRAG 如何幫助解決傳統向量檢索無法解決的「多跳推理」問題。

**初步方案 (V1)**：團隊構建了一個 Naive RAG 系統，知識庫包含了公司所有的 IT 幫助文檔。

**運行結果**：對於「如何重置密碼」這類簡單問題，系統表現良好。但對於「伺服器連接失敗」這類複雜問題，系統經常給出錯誤或無關的答案，例如，它可能會檢索到一篇關於「如何設置郵箱伺服器」的文檔，因為其中也包含了「伺服器」這個詞。

**問題**：

1.  **問題診斷**：V1 方案的失敗主要反映了 Naive RAG 的哪些局限性？

2.  **方案升級 (V2)**：請參考本章介紹的 Advanced RAG 和 Modular RAG 思想，為該公司設計一個更優的 V2 方案。您的方案應詳細說明：
    a. 如何處理不同難度的查詢？（提示：可以借鑒 Adaptive-RAG 的思想）
    b. 如何提升檢索的準確性？（提示：可以考慮哪些檢索前/後優化技術？）
    c. 如果知識庫文檔不夠用，系統應該如何主動獲取更多資訊？（提示：可以借鑒 Corrective RAG 或 Agentic RAG 的思想）

3.  **長遠思考**：從長遠來看，您認為將這個 RAG 系統發展為一個 Agentic RAG，能為企業帶來哪些更大的價值？

---

*（練習題參考答案將在附錄中提供）*


---

## 🧠 本章練習題

### **初級 (Beginner)**

1.  **選擇題**：Naive RAG 的工作流程不包含以下哪個步驟？
    A. 索引 (Indexing)
    B. 重排序 (Reranking)
    C. 檢索 (Retrieval)
    D. 生成 (Generation)

2.  **填空題**：Advanced RAG 的優化主要圍繞著 ________、________ 和 ________ 三個環節展開。

3.  **判斷題**：句子窗口檢索（Sentence Window Retrieval）的核心思想是「用大塊檢索，用小塊生成」。（是/非）

4.  **簡答題**：請簡要解釋什麼是「查詢擴展（Query Expansion）」，並舉一個例子。

### **中級 (Intermediate)**

1.  **比較題**：請比較「父子塊檢索 (Parent-Child Chunking)」和「句子窗口檢索 (Sentence Window Retrieval)」這兩種進階檢索策略的異同點。

2.  **簡答題**：在多輪對話中，如果一個 RAG 系統直接使用用戶的最新問題（如「它有什麼特點？」）進行檢索，可能會遇到什麼問題？Advanced RAG 中的哪項技術專門用來解決這個問題？

3.  **思考題**：Modular RAG 相比於 Advanced RAG 最大的架構優勢是什麼？請用「解耦」和「編排」這兩個概念來解釋。

4.  **設計題**：假設你要設計一個 RAG 系統，用於回答關於「某款手機的用戶手冊」的問題。你會選擇「父子塊檢索」還是「句子窗口檢索」策略？請說明你的理由。

### **高級 (Advanced)**

1.  **論述題**：請闡述 Agentic RAG 中「規劃（Planning）」、「工具使用（Tool Use）」和「反思（Reflection）」這三個核心機制是如何協同工作的。並以「自動生成季度營運報告」為例，說明每個機制在其中扮演的角色。

2.  **設計題**：假設你需要構建一個能夠回答「今天天氣怎麼樣？」以及「幫我總結一下最近關於 AI 的新聞」的 RAG 系統。請設計一個 Modular RAG 的架構，說明你需要哪些不同的「檢索模組」或「工具」，以及「編排器」應該如何根據問題類型來調度它們。

3.  **批判性思考題**：RAG-Fusion 通過生成多個假設性問題來提高召回率，但這也可能引入與原始查詢不相關的「噪聲」。你認為可以如何設計一個機制來過濾這些由 LLM 生成的、質量不高的假設性問題，從而實現「精準擴展」？
